<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script>
    function setUp() {
      sp = document.getElementById('output_1');
      sp2 = document.getElementById('output_2');
      mot = [];
      mot_maxs = [];
      calibratin = true;
      cal_timeout = null;
      monitorin = True;
      selectin = False;
      selectd = False;
      lev_ind = [0,0];
      waitOut = null;
      dv = document.getElementById('console');
      ops = [["letters A to D, and space","letters E to H, and delete","letters I to N", "letters to O to T", "letters U to Z", "back to beginning", "stop"],
      [["A","B",'C','D','space'],['E','F','G','H','delete'],['I','J','K','L','M','N'],['O','P','Q','R','S','T'],['U','V','W','X','Y','Z']],
      'You have selected '];
    }
    function calibrateStillness(event) {
      mot = [Math.abs(event.acceleration.x).toFixed(4),Math.abs(event.acceleration.y).toFixed(4),Math.abs(event.acceleration.z).toFixed(4)];
      sp2.innerHTML = mot.toString();
      if(mot_maxs.length == 0) {
        mot_maxs = [Math.abs(event.acceleration.x).toFixed(4),Math.abs(event.acceleration.y).toFixed(4),Math.abs(event.acceleration.z).toFixed(4)];
      }else{
        mot_maxs = [Math.max(Math.abs(event.acceleration.x).toFixed(4),mot_maxs[0]),Math.max(Math.abs(event.acceleration.y).toFixed(4),mot_maxs[1]),Math.max(Math.abs(event.acceleration.z).toFixed(4),mot_maxs[2])];
      }
    }
    function playOptions() {
      const uttr = new SpeechSynthesisUtterance(ops[lev_ind[0]][lev_ind[1]]);
      uttr.addEventListener('end', waitIt);
      window.speechSynthesis.speak(uttr);
      dv.innerHTML += ops[lev_ind[0]][lev_ind[1]]+'<br />';
    }
    function waitIt(event) {
      waitOut = setTimeout(nextOption,2000);
    }
    function nextOption() {
      if(lev_ind[1] < ops[lev_ind[0]].length-1) {
        lev_ind[1] += 1;
        playOptions();
      }else{
        lev_ind = [0,0];
        selectin = False;
      }
    }
    function allowMonitorin() {
      monitorin = True;
    }
    function monitorMovement(event) {
      mot = [Math.abs(event.acceleration.x).toFixed(4),Math.abs(event.acceleration.y).toFixed(4),Math.abs(event.acceleration.z).toFixed(4)];
      sp2.innerHTML = mot.toString();
      if(mot[0] > mot_maxs[0]*1.1 || mot[1] > mot_maxs[1]*1.1 || mot[2] > mot_maxs[2]*1.1) {
        if(monitorin) {
          monitorin = False;
          setTimeout(allowMonitorin,2000);
          if(selectin) {
            selectin = False;
            selectd = True;
          }else{
            selectin = True;
            playOptions();
          }
        }
      }
    }
    function ask() {
      sp.innerHTML = 'Calibrating...';
      window.speechSynthesis.speak(new SpeechSynthesisUtterance('calibrating, please relax'));
      if(DeviceMotionEvent && typeof DeviceMotionEvent.requestPermission === "function") {
        DeviceMotionEvent.requestPermission();
      }
      window.addEventListener('devicemotion', calibrateStillness);
      cal_timeout = setTimeout(function() {
        calibratin = false;
        //sp.innerHTML = 'Stillness has been monitored. Movements can now be detected.';
        sp.innerHTML = mot_maxs.toString();
        window.speechSynthesis.speak(new SpeechSynthesisUtterance('calibration complete'));
        window.removeEventListener('devicemotion', calibrateStillness);
        window.addEventListener('devicemotion', monitorMovement);
      }, 5000);
    }
    </script>
  </head>
  <body onload="setUp();">
    <h2>Mobile Movement Monitor  - 13</h2>
    <span id='output_1'>Please give Uncle Bertram the phone, and then press start to calibrate stillness.</span><br />
    <span id='output_2'></span><br />
    <p>Please note, the phone should be set to avoid time out.</p>
    <button id='permission' onclick="ask();">Start</button>
    <div id='console'>
      
    </div>

  </body>
</html>
