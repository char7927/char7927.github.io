<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script>
    function setUp() {
      sp = document.getElementById('output_1');
      sp2 = document.getElementById('output_2');
      mot = [];
      mot_maxs = [];
      calibratin = true;
      cal_timeout = null;
      monitorin = true;
    }
    function calibrateStillness(event) {
      mot = [Math.abs(event.acceleration.x).toFixed(4),Math.abs(event.acceleration.y).toFixed(4),Math.abs(event.acceleration.z).toFixed(4)];
      sp2.innerHTML = mot.toString();
      if(mot_maxs.length == 0) {
        mot_maxs = [Math.abs(event.acceleration.x).toFixed(4),Math.abs(event.acceleration.y).toFixed(4),Math.abs(event.acceleration.z).toFixed(4)];
      }else{
        mot_maxs = [Math.max(Math.abs(event.acceleration.x).toFixed(4),mot_maxs[0]),Math.max(Math.abs(event.acceleration.y).toFixed(4),mot_maxs[1]),Math.max(Math.abs(event.acceleration.z).toFixed(4),mot_maxs[2])];
      }
    }
    function monitorMovement(event) {
      mot = [Math.abs(event.acceleration.x).toFixed(4),Math.abs(event.acceleration.y).toFixed(4),Math.abs(event.acceleration.z).toFixed(4)];
      sp2.innerHTML = mot.toString();
      if(monitorin) {
        if(mot[0] > mot_maxs[0]*1.1 || mot[1] > mot_maxs[1]*1.1 || mot[2] > mot_maxs[2]*1.1) {
          monitorin = false;
          sp.innerHTML = '';
          const uttr = new SpeechSynthesisUtterance('row one, a to d and space');
          uttr.addEventListener('end', (event) => {monitorin = true;});
          window.speechSynthesis.speak(uttr);
        }
      }
    }
    function ask() {
      sp.innerHTML = 'Calibrating...';
      window.speechSynthesis.speak(new SpeechSynthesisUtterance('calibrating, please relax'));
      if(DeviceMotionEvent && typeof DeviceMotionEvent.requestPermission === "function") {
        DeviceMotionEvent.requestPermission();
      }
      window.addEventListener('devicemotion', calibrateStillness);
      cal_timeout = setTimeout(function() {
        calibratin = false;
        //sp.innerHTML = 'Stillness has been monitored. Movements can now be detected.';
        sp.innerHTML = mot_maxs.toString();
        window.removeEventListener('devicemotion', calibrateStillness);
        window.addEventListener('devicemotion', monitorMovement);
      }, 5000);
    }
    </script>
  </head>
  <body onload="setUp();">
    <h2>Mobile Movement Monitor  - 10</h2>
    <span id='output_1'>Please give Uncle Bertram the phone, and then press start to calibrate stillness.</span><br />
    <span id='output_2'></span><br />
    <p>Please note, the phone should be set to avoid time out.</p>
    <button id='permission' onclick="ask();">Start</button>
    <!--<textarea id="textInput" rows="4" cols="50" placeholder="Type something..."></textarea><br>
    <button onclick="speak()">Speak</button>

    <script>
        function speak() {
            const text = document.getElementById('textInput').value;
            const utterance = new SpeechSynthesisUtterance(text);
            window.speechSynthesis.speak(utterance);
        }
    </script>-->

  </body>
</html>
