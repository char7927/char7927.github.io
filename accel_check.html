<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Untitled Document</title>
	<script>
		var obj = new Object();
		const webSocket = new WebSocket('wss://uclbiochem.loca.lt');
		obj.myId = -1;
		obj.closeMe = 0;
		webSocket.onmessage = (event) => {
			var m_obj = JSON.parse(event.data);
			if(m_obj.hasOwnProperty('id')) {
				obj.myId = m_obj['id'];
			}
		};
		function init() {
		}
		function rp1(e) {
			if(typeof DeviceMotionEvent.requestPermission === 'function') {
				DeviceMotionEvent.requestPermission().then(permissionState => {
          			if(permissionState === 'granted') {
            			/*window.addEventListener('devicemotion', (e) => {
							document.getElementById('rep4').innerHTML = e.acceleration.x;
						});*/
						window.addEventListener('devicemotion', recordMotion);
						document.getElementById("r1").setAttribute("hidden", "hidden");
						document.getElementById("r2").removeAttribute("hidden");
          			}
        		}).catch(console.error);
    		} else {
      // handle regular non iOS 13+ devices
    		}
		}
		function rp2(e) {
			if(typeof DeviceOrientationEvent.requestPermission === 'function') {
				DeviceOrientationEvent.requestPermission().then(permissionState => {
          			if(permissionState === 'granted') {
            			/*window.addEventListener('devicemotion', (e) => {
							document.getElementById('rep4').innerHTML = e.acceleration.x;
						});*/
						window.addEventListener('deviceorientation', recordOrientation);
						document.getElementById("r2").setAttribute("hidden", "hidden");
						document.getElementById('rep8').innerHTML = "Permission granted";
          			}
        		}).catch(console.error);
    		} else {
      // handle regular non iOS 13+ devices
    		}
		}
		function recordMotion(e) {
			document.getElementById('rep4').innerHTML = String(e.acceleration.x)+","+String(e.acceleration.y)+","+String(e.acceleration.z);
			document.getElementById('rep5').innerHTML = String(e.accelerationIncludingGravity.x)+","+String(e.accelerationIncludingGravity.y)+","+String(e.accelerationIncludingGravity.z)
			document.getElementById('rep6').innerHTML = String(e.rotationRate.alpha)+","+String(e.rotationRate.beta)+","+String(e.rotationRate.gamma);
			document.getElementById('rep7').innerHTML = e.interval;
			obj.accel_x = e.acceleration.x;
			obj.accel_y = e.acceleration.y;
			obj.accel_z = e.acceleration.z;
		}
		function recordOrientation(e) {
			document.getElementById('rep0').innerHTML = e.absolute;
			document.getElementById('rep1').innerHTML = e.alpha;
			document.getElementById('rep2').innerHTML = e.beta;
			document.getElementById('rep3').innerHTML = e.gamma;
			obj.alpha = e.alpha;
			obj.beta = e.beta;
			obj.gamma = e.gamma;
		}
		myInterval = setInterval(sendMotionObject, 1000);
		function sendMotionObject() {
			console.log('sending');
			webSocket.send(JSON.stringify(obj));
		}
		window.addEventListener('beforeunload', () => {
			var messgObject = {id: myID, closeMe: 1, messg: ""};
			webSocket.send(JSON.stringify(messgObject));
		});
	</script>
</head>

<body onload="init();">
	<p hidden>absolute orientation: <span id='rep0'></div></p>
	<p>alpha: <span id='rep1'></span></p>
	<p>beta: <span id='rep2'></span></p>
	<p>gamma: <span id='rep3'></span></p>
	<p>acceleration: <span id='rep4'></span></p>
	<p>accelerationIncludingGravity: <span id='rep5'></span></p>
	<p>rotationRate: <span id='rep6'></span></p>
	<p>interval: <span id='rep7'></span></p>
	<p>Support: <span id='rep8'>Please click buttons to allow detection:</span></p>
	<button id="r1" onclick="rp1()">Allow Motion Detection</button>
	<button id="r2" onclick="rp2()" hidden>Allow Orientation Detection</button>
</body>
</html>
